import re
import sys
import os
import zmq
import argparse
from random import randint

sys.path.append(os.path.abspath("csp_zmq"))
print(sys.path)

from zmqnode import CspZmqNode
from zmqnode import threaded
from zmqnode import CspHeader


class CspZmqHub(CspZmqNode):

    def __init__(self, ip="localhost", in_port="8002", out_port="8001", mon_port="8003", reader=True, writer=False, proto="tcp"):
        """
        CSP ZMQ HUB
        Is a PUB-SUB proxy that allow to interconnect a set of publisher and subscriber nodes.
        NODE:PUB:OUT_PORT <----> HUB:XSUB:IN_PORT|::|HUB:XPUB:OUT_PORT <----> NODE:SUB:IN_PORT

        :param in_port: input port, XSUB socket. (Should match nodes output port, PUB sockets)
        :param out_port: output port, XPUB socket. (Should match nodes input port, SUB sockets)
        :param mon_port: monitor port, internal PUB-SUB socket.
        :param reader: activate monitor
        :param writer: activate console
        """
        CspZmqNode.__init__(self, None, ip, mon_port, in_port, reader, writer, proto)
        self.mon_port_hub = mon_port
        self.out_port_hub = out_port
        self.in_port_hub = in_port

    def read_message(self, message, header=None):
        print(message)

    @threaded
    def console_hub(self):
        prompt = "[mac] <node> <port> <message>: "
        try:
            while self._run:
                #dest, port, msg = input(prompt).split(' ', 2)
                arguments = input(prompt)
                arguments = [a for a in re.split(r"(\d+) ", arguments) if a]
                if len(arguments) > 3:
                    mac, dest, port, msg = arguments[:]
                else:
                    dest, port, msg = arguments[:]
                    mac = dest
                print(dest, port, msg, mac)
                hdr = CspHeader(src_node=0, dst_node=int(dest), dst_port=int(port), src_port=randint(48, 63))
                hdr.mac_node = mac
                print(hdr, msg)
                self.send_message(msg, hdr)
        except Exception as e:
            print(e)
        print("Console stopped!")

    def start(self):
        # Start default writer and reader
        CspZmqNode.start(self)

        # Create sockets
        xpub_out = self._context.socket(zmq.XPUB)
        xsub_in = self._context.socket(zmq.XSUB)
        hub_ip = "*" if self._proto == "tcp" else self.hub_ip
        xpub_out.bind('{}://{}:{}'.format(self._proto, hub_ip, self.out_port_hub))
        xsub_in.bind('{}://{}:{}'.format(self._proto, hub_ip, self.in_port_hub))

        s_mon = None
        if self.monitor:
            # Crate monitor socket
            s_mon = self._context.socket(zmq.PUB)
            s_mon.bind('tcp://*:{}'.format(self.mon_port_hub))

        if self.console:
            self.console_hub()

        # Start ZMQ proxy (blocking)
        try:
            zmq.proxy(xsub_in, xpub_out, s_mon)

        except KeyboardInterrupt as e:
            print("Main:", e)

        finally:
            # print("Closing due to", e)
            xsub_in.setsockopt(zmq.LINGER, 0)
            xsub_in.close()
            xpub_out.close()
            if s_mon:
                s_mon.close()

            self.stop()


def get_parameters():
    """ Parse command line parameters """
    parser = argparse.ArgumentParser()

    parser.add_argument("-i", "--in_port", default="8002", help="Input port")
    parser.add_argument("-o", "--out_port", default="8001", help="Output port")
    parser.add_argument("-m", "--mon_port", default="8003", help="Monitor port")
    parser.add_argument("-d", "--ip", default="localhost", help="Hub IP address")
    parser.add_argument("-p", "--proto", default="tcp", help="Monitor port")
    parser.add_argument("--mon", action="store_true", help="Enable monitor socket")
    parser.add_argument("--wrt", action="store_true", help="Enable console task")

    return parser.parse_args()


if __name__ == "__main__":
    # Get arguments
    args = get_parameters()
    print(args)
    zmqhub = CspZmqHub(args.ip, args.in_port, args.out_port, args.mon_port, args.mon, args.wrt, args.proto)
    zmqhub.start()



